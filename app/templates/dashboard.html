{% extends "base.html" %}

{% block content %}
<div class="bg-white dark:bg-slate-800 shadow-md rounded-lg p-6">
    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
        <h1 class="text-2xl font-bold">Welcome, <span class="text-blue-500">{{ current_user.username }}</span>!</h1>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Column for Tracked Teams -->
        <div>
            <div class="flex justify-between items-center border-b-2 border-slate-200 dark:border-slate-700 pb-2 mb-4">
                <h2 class="text-xl font-semibold text-slate-700 dark:text-slate-200">Tracked Teams</h2>
                {% if tracked_teams %}
                <form action="{{ url_for('untrack_all_teams') }}" method="post">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="bg-red-800 hover:bg-red-700 text-white font-semibold py-1 px-3 text-xs rounded-md transition">Untrack All</button>
                </form>
                {% endif %}
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 min-h-[200px]">
                {% if tracked_teams %}
                    <ul class="space-y-3">
                        {% for item in tracked_teams %}
                        <li class="bg-slate-200 dark:bg-slate-700/60 rounded-md p-3"
                            data-item-id="{{ item.id }}"
                            data-match-id="{{ item.event.match_id }}"
                            data-sport-name="{{ item.event.league.sport.name }}"
                            data-tracked-team-id="{{ item.team.external_id }}">
                            {% include 'partials/_dashboard_item.html' %}
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-slate-500 dark:text-slate-400">You are not tracking any teams yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Column for Tracked Players -->
        <div>
            <div class="flex justify-between items-center border-b-2 border-slate-200 dark:border-slate-700 pb-2 mb-4">
                <h2 class="text-xl font-semibold text-slate-700 dark:text-slate-200">Tracked Players</h2>
                {% if tracked_players %}
                <form action="{{ url_for('untrack_all_players') }}" method="post">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="bg-red-800 hover:bg-red-700 text-white font-semibold py-1 px-3 text-xs rounded-md transition">Untrack All</button>
                </form>
                {% endif %}
            </div>
            <div class="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 min-h-[200px]">
                {% if tracked_players %}
                    <ul class="space-y-3">
                        {% for item in tracked_players %}
                        <li class="bg-slate-200 dark:bg-slate-700/60 rounded-md p-3"
                            data-item-id="{{ item.id }}"
                            data-match-id="{{ item.event.match_id }}"
                            data-sport-name="{{ item.event.league.sport.name }}"
                            data-tracked-player-id="{{ item.player.external_id }}">
                            {% include 'partials/_dashboard_item.html' %}
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-slate-500 dark:text-slate-400">You are not tracking any players yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("Connecting to user dashboard SSE stream...");
        const eventSource = new EventSource("{{ url_for('dashboard_stream') }}");

        function highlightElement(element) {
            if (!element) return;
            element.classList.remove('highlight-update');
            void element.offsetWidth;
            element.classList.add('highlight-update');
        }

        function updateCell(id, newValue) {
            const cell = document.getElementById(id);
            if (cell && cell.textContent.trim() !== newValue.toString()) {
                cell.textContent = newValue;
                highlightElement(cell.closest('tr') || cell);
            }
        }

        eventSource.onmessage = function(event) {
            const matchData = JSON.parse(event.data);
            const matchId = matchData.match_id || matchData.id;
            const listItems = document.querySelectorAll(`li[data-match-id="${matchId}"]`);
            if (!listItems) return;
            listItems.forEach(listItem => {
                const trackedPlayerId = listItem.dataset.trackedPlayerId;
                const trackedTeamId = listItem.dataset.trackedTeamId;
                const sportName = listItem.dataset.sportName;
                const itemId = listItem.dataset.itemId;
                const unstartedView = document.getElementById(`unstarted-view-${itemId}`);
                const statsView = document.getElementById(`stats-view-${itemId}`);
                const statusSpan = document.getElementById(`status-span-${itemId}`);
                if (statusSpan) statusSpan.textContent = matchData.state;
                if (matchData.state !== 'unstarted') {
                    if (unstartedView) unstartedView.style.display = 'none';
                    if (statsView) statsView.style.display = 'block';
                } else {
                    if (unstartedView) unstartedView.style.display = 'block';
                    if (statsView) statsView.style.display = 'none';
                }
                if (sportName === 'League of Legends') {
                    matchData.games.forEach(game => {
                        // Update all player stats in the box score using the unique item ID
                        for (const p_id in game.participants) {
                            const p_stat = game.participants[p_id];
                            updateCell(`item-${itemId}-game-${game.game_id}-player-${p_stat.p_id}-kda`, `${p_stat.kills}/${p_stat.deaths}/${p_stat.assists}`);
                        }

                        if (trackedPlayerId) {
                            for (const p_id in game.participants) {
                                const p_stat = game.participants[p_id];
                                if (String(p_stat.id) === String(trackedPlayerId)) {
                                    updateCell(`item-${itemId}-game-${game.game_id}-kda`, `${p_stat.kills}/${p_stat.deaths}/${p_stat.assists}`);
                                    updateCell(`item-${itemId}-game-${game.game_id}-cs`, p_stat.creeps);
                                }
                            }
                        }
                    });
                } else if (sportName === 'Baseball') {
                    if (trackedTeamId) {
                        if (matchData.away_team) {
                            if (String(matchData.away_team.id) === String(trackedTeamId)) {
                                highlightElement(document.getElementById(`item-${itemId}-mlb-match-${matchId}-team-${matchData.away_team.id}-box`));
                            }
                            for (const playerId in matchData.away_team.players) {
                                updateCell(`item-${itemId}-mlb-match-${matchId}-player-${playerId}-summary`, matchData.away_team.players[playerId].summary);
                            }
                        }
                        if (matchData.home_team) {
                            if (String(matchData.home_team.id) === String(trackedTeamId)) {
                                highlightElement(document.getElementById(`item-${itemId}-mlb-match-${matchId}-team-${matchData.home_team.id}-box`));
                            }
                            for (const playerId in matchData.home_team.players) {
                                updateCell(`item-${itemId}-mlb-match-${matchId}-player-${playerId}-summary`, matchData.home_team.players[playerId].summary);
                            }
                        }
                    } else if (trackedPlayerId) {
                        const allPlayers = { ...matchData.away_team.players, ...matchData.home_team.players };
                        if (allPlayers[trackedPlayerId]) {
                            updateCell(`item-${itemId}-summary`, allPlayers[trackedPlayerId].summary);
                        }
                    }
                }
            });
        };

        eventSource.onerror = function(err) {
            console.error("Dashboard EventSource failed:", err);
            eventSource.close();
        };
    });
</script>
{% endblock %}
